-- ฐานข้อมูลที่ใช้มาจาก chinook.db และใช้ gemini ในการสร้างโจทย์ขึ้นมา



-- 1. หาว่าในฐานข้อมูลนี้ ศิลปิน (Artist) แต่ละคนมี จำนวนอัลบั้ม (Number of Albums) ทั้งหมดกี่อัลบั้ม?
select 
  artists.Name artname,
  count(albums.AlbumId) calb
from artists 
join albums
  on artists.ArtistId = albums.ArtistId
group by artname
order by calb desc

-- 2จงหา ประเทศ (BillingCountry) ที่มีมูลค่าการขาย (Total Sales) รวม เกิน 100.00
select invoices.BillingCountry,
  sum(invoices.Total) Total_Sales 
from invoices
group by invoices.BillingCountry
having sum(invoices.Total) > 100.00
order by sum(invoices.Total) desc


-- 3 แสดงรายชื่อลูกค้าที่มียอดซื้อรวม (Total Spending) สูงกว่าค่าเฉลี่ย ของลูกค้าทั้งหมด
WITH CustomerSpending AS (
    SELECT CustomerId, SUM(Total) as TotalSpend
    FROM invoices
    GROUP BY CustomerId
)
SELECT 
    c.FirstName, 
    c.LastName, 
    cs.TotalSpend
FROM customers c
JOIN CustomerSpending cs ON c.CustomerId = cs.CustomerId
WHERE cs.TotalSpend > (SELECT AVG(TotalSpend) FROM CustomerSpending) -- ขั้นที่ 2: เทียบกับค่าเฉลี่ยยอดรวม
ORDER BY cs.TotalSpend DESC;


--โจทย์4: จงหาชื่อศิลปิน 5 อันดับแรกที่ทำรายได้ (Total Sales) ให้กับร้านมากที่สุด โดยคำนวณจากยอดขายรวมในตาราง invoice_items

select art.Name, sum(ii.Quantity*ii.UnitPrice) as totalSales
from artists art
join albums alb on alb.ArtistId = art.ArtistId
join tracks tr on tr.AlbumId = alb.AlbumId
join invoice_items ii on ii.TrackId = tr.TrackId
group by art.Name
order by totalSales desc
limit 5

-- โจทย์5: จงแสดงรายชื่อพนักงานตำแหน่ง 'Sales Support Agent' พร้อมระบุว่าแต่ละคนมียอดรวมการขาย (Total Revenue) เท่าไหร่ และดูแลลูกค้า (Customer Count) กี่ราย
select 
  e.FirstName || ' ' ||  e.LastName  EmployeeName,
  count(distinct c.CustomerId) CountCustomer,
  sum(i.Total) TotalRevenue
from employees e
join customers c on c.SupportRepId = e.EmployeeId
join invoices i on i.CustomerId = c.CustomerId
where e.Title = 'Sales Support Agent'
group by EmployeeName
order by TotalRevenue desc

-- โจทย์6: "จงหาว่า ประเทศใดบ้าง ที่มียอดขายเพลงแนว 'Rock' รวมกันแล้ว มากกว่า 50 รายการ (Quantity)"
select  i.BillingCountry Country, sum(ii.Quantity) TotalSales
from invoices i
join invoice_items ii on ii.InvoiceId = i.InvoiceId
join tracks t on t.TrackId = ii.TrackId
join genres g on g.GenreId = t.GenreId
where g.Name = 'Rock'
group by Country
having TotalSales > 50
order by TotalSales DESC
